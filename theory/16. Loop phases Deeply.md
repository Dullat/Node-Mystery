
`process.nextTick`, Promises/microtasks, and the event loop phases interact **inside a single tick and across multiple ticks**.

---

```js
const fs = require('fs');

console.log("---- Script start (synchronous code) ----");

// 1️⃣ Synchronous code runs first
// --------------------------------
console.log("Synchronous 1");

process.nextTick(() => console.log("nextTick 1 (runs right after sync code before promises)"));

Promise.resolve().then(() => console.log("promise 1 (microtask after nextTicks)"));

// Schedule a timer (macrotask - Timers phase)
setTimeout(() => {
    console.log("\n---- Timers phase ----");
    console.log("Timer 1 callback");

    process.nextTick(() => console.log("nextTick inside Timer 1"));
    Promise.resolve().then(() => console.log("Promise inside Timer 1"));

}, 0);

// Schedule an immediate (macrotask - Check phase)
setImmediate(() => {
    console.log("\n---- Check phase ----");
    console.log("setImmediate 1 callback");

    process.nextTick(() => console.log("nextTick inside setImmediate 1"));
    Promise.resolve().then(() => console.log("Promise inside setImmediate 1"));
});

// Schedule an async file read (macrotask - Poll phase)
fs.readFile(__filename, () => {
    console.log("\n---- Poll phase (I/O callback) ----");
    console.log("fs.readFile callback");

    process.nextTick(() => console.log("nextTick inside fs.readFile"));
    Promise.resolve().then(() => console.log("Promise inside fs.readFile"));
});

console.log("Synchronous 2");

// More nextTicks & promises after other sync code
process.nextTick(() => console.log("nextTick 2 (still before promises in script)"));
Promise.resolve().then(() => console.log("promise 2 (microtask after nextTicks)"));

console.log("---- Script end (sync part done) ----");
```

---

### **Expected Output (conceptual order)**

```
---- Script start (synchronous code) ----
Synchronous 1
Synchronous 2
---- Script end (sync part done) ----
nextTick 1 (runs right after sync code before promises)
nextTick 2 (still before promises in script)
promise 1 (microtask after nextTicks)
promise 2 (microtask after nextTicks)

---- Timers phase ----
Timer 1 callback
nextTick inside Timer 1
Promise inside Timer 1

---- Poll phase (I/O callback) ----
fs.readFile callback
nextTick inside fs.readFile
Promise inside fs.readFile

---- Check phase ----
setImmediate 1 callback
nextTick inside setImmediate 1
Promise inside setImmediate 1
```

---

### **How to Read This**

1. **Sync first:**  
    JS runs top-to-bottom, logging sync stuff immediately.
    
2. **Between phases:**  
    After the sync part, Node empties the `process.nextTick` queue, then the Promise/microtask queue, **before** moving to timers.
    
3. **Inside each macrotask phase:**  
    After a phase’s callbacks, Node **again** checks `process.nextTick` first, then Promises, before moving to the next phase.
    
4. **Order of phases in this example:**
    
    - Timers (setTimeout)
        
    - Poll (fs.readFile)
        
    - Check (setImmediate)
        
    - Close callbacks (not used here)
        

---

If you run this, you’ll **see** that microtasks (`nextTick` + Promises) run **not just once after the script ends**, but **after every phase** inside a single tick.

---
